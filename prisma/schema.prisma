generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  BACKOFFICE
  TECHNICIAN
  PLANNER
  SUPERVISOR
  HELPDESK
  AUDITOR
}

enum TechnicianShiftType {
  DIURNO_AM
  DIURNO_PM
  NOCTURNO
}

enum TechnicianRestDay {
  SATURDAY
  SUNDAY
}

enum StsTicketSeverity {
  EMERGENCY
  HIGH
  MEDIUM
  LOW
}

enum StsTicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_VENDOR
  RESOLVED
  CLOSED
}

enum StsTicketChannel {
  PHONE
  EMAIL
  CHAT
  OTHER
}

enum StsTicketEventType {
  STATUS_CHANGE
  COMMENT
  ASSIGN
  SYSTEM
}

enum StsKpiMetric {
  SUPPORT_RESPONSE
  AVAILABILITY
  PREVENTIVE_MAINTENANCE
  TRANSMISSION
  DATA_CAPTURE
  RECORDING
  IMAGE_QUALITY_RECORDED
  IMAGE_QUALITY_TRANSMITTED
  PANIC_ALARM_GENERATION
}

enum StsKpiPeriodicity {
  DAILY
  WEEKLY
  MONTHLY
}

enum CalendarSlotKind {
  AVAILABLE
  BLOCKED
  TIME_OFF
}

enum CaseType {
  NOVEDAD
  CORRECTIVO
  PREVENTIVO
  MEJORA_PRODUCTO
  SOLICITUD_DESCARGA_VIDEO
}

enum CaseStatus {
  NUEVO
  OT_ASIGNADA
  EN_EJECUCION
  RESUELTO
  CERRADO
}

enum WorkOrderStatus {
  CREADA
  ASIGNADA
  EN_CAMPO
  FINALIZADA
}

enum MediaKind {
  FOTO_INICIO
  FOTO_FIN
}

enum CaseEventType {
  CREATED
  ASSIGNED
  NOTIFIED
  STATUS_CHANGE
  COMMENT
}

model Tenant {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())

  buses         Bus[]
  cases         Case[]
  workOrders    WorkOrder[]
  users         User[]
  notifications Notification[]
  technicianSchedules TechnicianSchedule[]
  technicianWeekCalendars TechnicianWeekCalendar[]
  stsComponents StsComponent[]
  stsTickets StsTicket[]
  stsSlaPolicies StsSlaPolicy[]
  stsKpiPolicies StsKpiPolicy[]
  stsKpiMeasurements StsKpiMeasurement[]
  stsMaintenanceWindows StsMaintenanceWindow[]
  stsAuditLogs StsAuditLog[]
  themeSettings ThemeSettings?

  sequence      TenantSequence?
}

model TenantSequence {
  tenantId String @id
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  nextCaseNo      Int @default(1)
  nextWorkOrderNo Int @default(1)

  updatedAt DateTime @updatedAt
}

model User {
  id           String @id @default(cuid())
  tenantId     String
  tenant       Tenant @relation(fields: [tenantId], references: [id])

  name         String
  email        String @unique

  // ✅ opcional para permitir "crear usuario" y luego enviar reset por correo
  passwordHash String?

  role         Role
  active       Boolean  @default(true)
  capabilities String[] @default([])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  assignedWorkOrders   WorkOrder[] @relation("WOAssignedTo")
  notifications        Notification[]
  passwordResetTokens  PasswordResetToken[]
  assignedVideoRequests VideoDownloadRequest[]
  uploadedVideoAttachments VideoAttachment[]
  videoRequestEvents VideoRequestEvent[]
  technicianSchedule TechnicianSchedule?
  plannerWeekCalendars TechnicianWeekCalendar[] @relation("PlannerCalendar")
  technicianWeekSlots TechnicianWeekSlot[] @relation("TechnicianSlots")
  stsTicketsAssigned StsTicket[] @relation("StsTicketsAssigned")
  stsTicketEvents StsTicketEvent[]
  stsAuditLogs StsAuditLog[]

  @@index([tenantId, role])
  @@index([tenantId, active])
}

model TechnicianSchedule {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  userId   String @unique
  user     User @relation(fields: [userId], references: [id], onDelete: Cascade)

  shiftType TechnicianShiftType
  restDay   TechnicianRestDay
  timezone  String @default("America/Bogota")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model TechnicianWeekCalendar {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  weekStart DateTime
  createdById String?
  createdBy   User? @relation("PlannerCalendar", fields: [createdById], references: [id])

  slots     TechnicianWeekSlot[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, weekStart])
  @@index([tenantId, weekStart])
}

model TechnicianWeekSlot {
  id           String   @id @default(cuid())
  calendarId   String
  calendar     TechnicianWeekCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  technicianId String
  technician   User @relation("TechnicianSlots", fields: [technicianId], references: [id], onDelete: Cascade)

  startAt DateTime
  endAt   DateTime
  kind    CalendarSlotKind
  note    String?

  createdAt DateTime @default(now())

  @@index([calendarId])
  @@index([technicianId, startAt])
}

model StsComponent {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  code   String
  name   String
  active Boolean @default(true)

  tickets     StsTicket[]
  slaPolicies StsSlaPolicy[]
  kpiPolicies StsKpiPolicy[]
  kpiMeasurements StsKpiMeasurement[]
  maintenanceWindows StsMaintenanceWindow[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId, active])
}

model StsTicket {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  caseId String? @unique
  case   Case? @relation(fields: [caseId], references: [id])

  componentId String
  component   StsComponent @relation(fields: [componentId], references: [id])

  severity StsTicketSeverity
  status   StsTicketStatus @default(OPEN)
  channel  StsTicketChannel

  description String
  vendorId    String?

  openedAt        DateTime
  firstResponseAt DateTime?
  resolvedAt      DateTime?
  closedAt        DateTime?

  assignedToId String?
  assignedTo   User? @relation("StsTicketsAssigned", fields: [assignedToId], references: [id])

  breachResponse   Boolean @default(false)
  breachResolution Boolean @default(false)

  events StsTicketEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, openedAt])
  @@index([tenantId, status])
  @@index([tenantId, severity])
  @@index([componentId, status])
}

model StsTicketEvent {
  id       String @id @default(cuid())
  ticketId String
  ticket   StsTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  type      StsTicketEventType
  status    StsTicketStatus?
  message   String?
  meta      Json?

  createdById String?
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@index([ticketId, createdAt])
}

model StsSlaPolicy {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  componentId String
  component   StsComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)

  severity StsTicketSeverity
  responseMinutes   Int
  resolutionMinutes Int
  pauseStatuses Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, componentId, severity])
  @@index([tenantId, severity])
}

model StsKpiPolicy {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  componentId String
  component   StsComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)

  metric      StsKpiMetric
  threshold   Decimal @db.Decimal(5, 2)
  periodicity StsKpiPeriodicity

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, componentId, metric, periodicity])
}

model StsKpiMeasurement {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  componentId String
  component   StsComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)

  metric      StsKpiMetric
  periodicity StsKpiPeriodicity
  periodStart DateTime
  periodEnd   DateTime
  value       Decimal @db.Decimal(6, 2)
  source      String?

  createdAt DateTime @default(now())

  @@index([tenantId, metric, periodicity, periodStart])
}

model StsMaintenanceWindow {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  componentId String?
  component   StsComponent? @relation(fields: [componentId], references: [id], onDelete: Cascade)

  startAt DateTime
  endAt   DateTime
  reason  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, startAt])
}

model StsAuditLog {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  actorId String?
  actor   User? @relation(fields: [actorId], references: [id])

  action     String
  entityType String
  entityId   String?
  meta       Json?

  createdAt DateTime @default(now())

  @@index([tenantId, createdAt])
}

model ThemeSettings {
  id       String @id @default(cuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  mode String @default("light")

  background       String
  foreground       String
  card             String
  cardForeground   String
  primary          String
  primaryForeground String
  border           String
  muted            String
  mutedForeground  String
  radius           String

  stsBg      String
  stsAccent  String
  stsAccent2 String

  backgroundDark       String @default("222.2 84% 4.9%")
  foregroundDark       String @default("210 40% 98%")
  cardDark             String @default("222.2 84% 4.9%")
  cardForegroundDark   String @default("210 40% 98%")
  primaryDark          String @default("210 40% 98%")
  primaryForegroundDark String @default("222.2 47.4% 11.2%")
  borderDark           String @default("217.2 32.6% 17.5%")
  mutedDark            String @default("217.2 32.6% 17.5%")
  mutedForegroundDark  String @default("215 20.2% 65.1%")
  stsBgDark      String @default("222 40% 12%")
  stsAccentDark  String @default("171 66% 36%")
  stsAccent2Dark String @default("207 73% 45%")

  fontSans    String
  fontDisplay String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId, expiresAt])
}

model Bus {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  code   String
  plate  String?
  active Boolean @default(true)

  createdAt  DateTime @default(now())
  equipments BusEquipment[]
  cases      Case[]
  lifecycle  BusLifecycleEvent[]

  @@unique([tenantId, code])
}

model EquipmentType {
  id            String @id @default(cuid())
  name          String @unique
  busEquipments BusEquipment[]
}

model BusEquipment {
  id    String @id @default(cuid())
  busId String
  bus   Bus    @relation(fields: [busId], references: [id])

  equipmentTypeId String
  equipmentType   EquipmentType @relation(fields: [equipmentTypeId], references: [id])

  serial   String?
  location String?
  active   Boolean @default(true)

  cases     Case[]
  caseEquipments CaseEquipment[]
  lifecycle BusLifecycleEvent[]
}

model Case {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // ✅ opcional mientras existan filas viejas; luego lo vuelves required
  caseNo   Int?

  busId String
  bus   Bus    @relation(fields: [busId], references: [id])

  busEquipmentId String?
  busEquipment   BusEquipment? @relation(fields: [busEquipmentId], references: [id])

  type     CaseType
  status   CaseStatus @default(NUEVO)
  priority Int        @default(3)

  title       String
  description String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workOrder WorkOrder?
  events    CaseEvent[]
  stsTicket StsTicket?

  videoDownloadRequest VideoDownloadRequest?
  caseEquipments        CaseEquipment[]

  @@unique([tenantId, caseNo])
  @@index([tenantId, createdAt])
  @@index([tenantId, status])
  @@index([tenantId, type])
}

model CaseEquipment {
  caseId String
  case   Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  busEquipmentId String
  busEquipment   BusEquipment @relation(fields: [busEquipmentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@id([caseId, busEquipmentId])
  @@index([busEquipmentId])
}

model CaseEvent {
  id     String @id @default(cuid())
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)

  type    CaseEventType
  message String?
  meta    Json?

  createdAt DateTime @default(now())

  @@index([caseId, createdAt])
}

model WorkOrder {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // ✅ opcional mientras existan filas viejas; luego lo vuelves required
  workOrderNo Int?

  caseId String @unique
  case   Case   @relation(fields: [caseId], references: [id])

  status        WorkOrderStatus @default(CREADA)
  assignedToId  String?
  assignedTo    User? @relation("WOAssignedTo", fields: [assignedToId], references: [id])
  assignedAt    DateTime?
  scheduledAt   DateTime?
  scheduledTo   DateTime?

  startedAt  DateTime?
  finishedAt DateTime?
  createdAt  DateTime @default(now())

  steps WorkOrderStep[]

  correctiveReport CorrectiveReport?
  preventiveReport PreventiveReport?

  @@unique([tenantId, workOrderNo])
  @@index([tenantId, createdAt])
  @@index([tenantId, status])
  @@index([assignedToId, status])
  @@index([assignedToId, scheduledAt])
}

model WorkOrderStep {
  id          String    @id @default(cuid())
  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id])

  stepType  String
  notes     String
  createdAt DateTime @default(now())

  media WorkOrderMedia[]
}

model WorkOrderMedia {
  id              String        @id @default(cuid())
  workOrderStepId String
  workOrderStep   WorkOrderStep @relation(fields: [workOrderStepId], references: [id])

  kind      MediaKind
  filePath  String
  createdAt DateTime @default(now())
}

model BusLifecycleEvent {
  id    String @id @default(cuid())
  busId String
  bus   Bus    @relation(fields: [busId], references: [id])

  busEquipmentId String?
  busEquipment   BusEquipment? @relation(fields: [busEquipmentId], references: [id])

  caseId      String?
  workOrderId String?

  eventType  String
  summary    String
  occurredAt DateTime @default(now())

  @@index([busId, occurredAt])
  @@index([busEquipmentId, occurredAt])
}

enum FailureType {
  HARDWARE_FISICA
  SOFTWARE
  CONECTIVIDAD
  OTRO
}

enum ProcedureType {
  AJUSTE_FISICO
  CAMBIO_COMPONENTE
  RECONFIGURACION
  REVISION
  OTRO
}

enum DeviceLocation {
  VAGON_1
  VAGON_2
  VAGON_3
  BO
  BFE
  BTE
  GABINETE_EQUIPOS
  FUELLE_V2_3
  OTRO
}

model CorrectiveReport {
  id String @id @default(cuid())

  workOrderId String    @unique
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  ticketNumber    String?
  workOrderNumber String?

  busCode      String?
  productionSp String?
  plate        String?

  deviceType String?
  brand      String?
  model      String?
  serial     String?

  procedureType  ProcedureType?
  procedureOther String?

  location      DeviceLocation?
  locationOther String?

  dateDismount     DateTime?
  dateDeliveredMfr DateTime?

  accessoriesSupplied Boolean @default(false)
  accessoriesWhich    String?

  physicalState String?
  diagnosis     String?
  failureType   FailureType?
  failureOther  String?

  solution        String?
  manufacturerEta String?

  installDate DateTime?
  newBrand    String?
  newModel    String?
  newSerial   String?
  inStock     Boolean?

  removedBrand  String?
  removedModel  String?
  removedSerial String?

  associatedCost Decimal? @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PreventiveReport {
  id String @id @default(cuid())

  workOrderId String    @unique
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  ticketNumber    String?
  workOrderNumber String?

  biarticuladoNo String?
  productionSp   String?
  mileage        String?
  plate          String?

  scheduledAt   DateTime?
  executedAt    DateTime?
  rescheduledAt DateTime?

  devicesInstalled Json?
  activities      Json?

  voltageNvrFromCard        String?
  voltageCollectorFromCard  String?
  voltageBatteriesMasterOff String?
  voltageCardMasterOn       String?
  voltageCardMasterOff      String?
  voltageSwitch             String?
  voltageCardBusOpen        String?
  commCableState            String?

  observations          String?
  timeStart             String?
  timeEnd               String?
  responsibleSkg        String?
  responsibleCapitalBus String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum VideoReqOrigin {
  TRANSMILENIO_SA
  INTERVENTORIA
  CAPITAL_BUS
  OTRO
}

enum VideoDeliveryMethod {
  WINSCP
  USB
  ONEDRIVE
}

enum VideoCaseStatus {
  EN_ESPERA
  EN_CURSO
  COMPLETADO
}

enum VideoDownloadStatus {
  DESCARGA_REALIZADA
  DESCARGA_FALLIDA
  BUS_NO_EN_PATIO
  PENDIENTE
}

enum VideoAttachmentKind {
  VIDEO
  OTRO
}

enum VideoRequestEventType {
  STATUS_CHANGE
  DOWNLOAD_STATUS_CHANGE
  EMAIL_SENT
  FILE_UPLOADED
  COMMENT
}

model VideoDownloadRequest {
  id     String @id @default(cuid())

  caseId String @unique
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)

  status         VideoCaseStatus    @default(EN_ESPERA)
  downloadStatus VideoDownloadStatus @default(PENDIENTE)

  origin      VideoReqOrigin
  requestType String?

  tmsaRadicado          String?
  tmsaFiledAt           DateTime?
  concessionaireFiledAt DateTime?

  requesterName  String?
  requesterId    String?
  requesterRole  String?
  requesterPhone String?
  requesterEmail String?
  requesterEmails Json?

  vehicleId String?

  eventStart DateTime?
  eventEnd   DateTime?

  camerasRequested String?
  deliveryMethod   VideoDeliveryMethod?

  descriptionNovedad String?
  finSolicitud       Json?
  observationsTechnician String?

  assignedToId String?
  assignedTo   User? @relation(fields: [assignedToId], references: [id])

  notifPendingSentAt         DateTime?
  notifInProgressSentAt      DateTime?
  notifDeliverySentAt        DateTime?
  notifFailedSentAt          DateTime?
  notifInternalDeliverySentAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attachments VideoAttachment[]
  events      VideoRequestEvent[]
}

model VideoAttachment {
  id        String @id @default(cuid())
  requestId String
  request   VideoDownloadRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  kind        VideoAttachmentKind
  filePath    String
  originalName String?
  size        Int?
  mimeType    String?
  active      Boolean @default(true)

  uploadedById String?
  uploadedBy   User? @relation(fields: [uploadedById], references: [id])

  tokens    VideoDownloadToken[]

  createdAt DateTime @default(now())

  @@index([requestId, kind])
}

model VideoRequestEvent {
  id        String @id @default(cuid())
  requestId String
  request   VideoDownloadRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  type    VideoRequestEventType
  message String?
  meta    Json?

  actorUserId String?
  actorUser   User? @relation(fields: [actorUserId], references: [id])

  createdAt DateTime @default(now())

  @@index([requestId, createdAt])
}

model VideoDownloadToken {
  id           String @id @default(cuid())
  token        String @unique
  attachmentId String
  attachment   VideoAttachment @relation(fields: [attachmentId], references: [id], onDelete: Cascade)

  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([attachmentId, expiresAt])
}

enum NotificationType {
  CASE_CREATED
  CASE_ASSIGNED
  WO_STARTED
  WO_FINISHED
  FORM_SAVED
  VIDEO_REQUEST_CREATED
  VIDEO_REQUEST_IN_PROGRESS
  VIDEO_REQUEST_DELIVERED
  VIDEO_REQUEST_FAILED
  VIDEO_REQUEST_INTERNAL_DELIVERED
}

model Notification {
  id        String @id @default(cuid())
  tenantId  String
  tenant    Tenant @relation(fields: [tenantId], references: [id])

  userId    String
  user      User   @relation(fields: [userId], references: [id])

  type      NotificationType
  title     String
  body      String?
  meta      Json?

  readAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId, readAt])
  @@index([tenantId, createdAt])
}
